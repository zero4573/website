<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src='https://libs.na.bambora.com/customcheckout/1/customcheckout.js'></script>

  <!-- import Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

  <style>
    .container {
      border: none;
      border-radius: 4px;
    }

    .user-entry-form {
      background-color: rgb(189, 222, 245);
    }

    /* card images are added to card number */
    #card-number {
      background-image: none;

      background-origin: content-box;
      background-position: calc(100%) center;
      background-repeat: no-repeat;
      background-size: contain;
    }

    .help-block {
      color: rgb(248, 51, 51);
    }
  </style>
</head>

<body>
  <div class="container mt-3">
    <h2>Iframe Demo Page</h2>
    <p>
      This page demonstrate how you can use <a href="https://dev.na.bambora.com/docs/guides/custom_checkout/">Bambora's
        Custom Checkout library</a> in combination with the
      <a href="https://dev.na.bambora.com/docs/references/payment_APIs/">Bambora Payment API</a> to achieve a fully
      customizable payment form
    </p>
    <p>For the below, you can use the test card number 4030 0000 1000 1234, with a security code 123 and any expiry date
      in the future.</p>
  </div>

  <div class="container user-entry-form py-3">
    <form id="checkout-form" class="form-inline">
      <div class="row">
        <div class="form-group col-xs-12 col-sm-6 has-feedback" id="card-number-bootstrap">
          <div id="card-number" class="form-control"></div>
          <label class="help-block" for="card-number" id="card-number-error"></label>
        </div>
        <div class="form-group col-xs-6 col-sm-3 has-feedback" id="card-cvv-bootstrap">
          <div id="card-cvv" class="form-control"></div>
          <label class="help-block" for="card-cvv" id="card-cvv-error"></label>
        </div>
        <div class="form-group col-xs-6 col-sm-3 has-feedback" id="card-expiry-bootstrap">
          <div id="card-expiry" class="form-control"></div>
          <label class="help-block" for="card-expiry" id="card-expiry-error"></label>
        </div>
        <div class="col-xs-12" style="display: flex;">
          <button id="pay-button" type="submit" class="btn btn-primary disabled" disabled="true">Pay</button>
        </div>
      </div>
    </form>

    <div class="row">
      <div class="col-lg-10">
        <div id="feedback"></div>
      </div>
    </div>
  </div>

  <div class="container">
    <p>For a more comprehensive list of test cards, <a
        href="https://dev.na.bambora.com/docs/references/payment_APIs/test_cards/">see the Bambora test cards page</a>
    </p>
  </div>

  <div class="container">
    <h2>Server side request</h2>
    <p>
      This section will use the token retrieved above and complete the transaction using the <a
        href="https://dev.na.bambora.com/docs/references/payment_APIs/">Bambora Payment API</a>.
      This step requires your merchant id + passcode, which is explained in the <a
        href="https://dev.na.bambora.com/docs/guides/merchant_quickstart/">merchant quickstart guide</a>.
    </p>
    <div class="alert alert-warning">
      Note for the purposes of this demo, we are making the request through the browser, however, this should actually
      be done through a remote server that
      would receive the tokenized card, and use your merchant id + passcode to make the request instead.
    </div>
  </div>

  <div class="container user-entry-form py-3">
    <div class="row">
      <div class="mb-3">
        <label for="merchant-id" class="form-label">CC Token</label>
        <input class="form-control" type="input" id="cc-token" disabled>
      </div>
      <div class="mb-3">
        <label for="merchant-id" class="form-label">Merchant Id</label>
        <input class="form-control" type="input" id="merchant-id">
      </div>
      <div class="mb-3">
        <label for="merchant-passcode" class="form-label">Merchant Passcode</label>
        <input class="form-control" type="input" id="merchant-passcode">
      </div>
      <div class="mb-3">
        <label for="purchase-amount" class="form-label">Purchase Amount</label>
        <input class="form-control" type="number" step="0.01" id="purchase-amount">
      </div>
      <div class="col-xs-12">
        <button id="submit-cc-token" type="submit" class="btn btn-primary" onclick="submitCCToken()">Complete</button>
      </div>
    </div>

    <div class="col-lg-10">
      <div id="purchase-feedback"><pre></pre></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>

  <script>
    async function submitCCToken() {
      const token = document.getElementById('cc-token').value;
      const id = document.getElementById('merchant-id').value;
      const passcode = document.getElementById('merchant-passcode').value;
      const amount = document.getElementById('purchase-amount').value;
      const base64EncodedPasscode = btoa(`${id}:${passcode}`);
      const feedback = document.getElementById('purchase-feedback');

      console.log("submitCCToken()");

      const body = {
        payment_method: 'token',
        amount: parseFloat(amount).toFixed(2),
      }

      const response = await fetch('https://api.na.bambora.com/v1/payments', {
        method: 'POST',
        cache: "no-cache",
        headers: {
          'Authorization': `Passcode ${base64EncodedPasscode}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(body),
      });

      feedback.setAttribute("class", "")
      const json = await response.json();
      if (response.status === 200) {
        feedback.classList.add('mt-3', 'alert', 'alert-success');
        feedback.childNodes[0].innerHTML = JSON.stringify(json, null, 2);
      } else {
        feedback.classList.add('mt-3', 'alert', 'alert-danger');
        feedback.childNodes[0].innerHTML = JSON.stringify(json, null, 2);
      }
    }

    (function () {
      var customCheckout = customcheckout();

      var isCardNumberComplete = false;
      var isCVVComplete = false;
      var isExpiryComplete = false;

      var customCheckoutController = {
        init: function () {
          console.log('checkout.init()');
          this.createInputs();
          this.addListeners();
        },
        createInputs: function () {
          console.log('checkout.createInputs()');
          var options = {};

          // Create and mount the inputs
          options.placeholder = 'Card number';
          customCheckout.create('card-number', options).mount('#card-number');

          options.placeholder = 'CVV';
          customCheckout.create('cvv', options).mount('#card-cvv');

          options.placeholder = 'MM / YY';
          customCheckout.create('expiry', options).mount('#card-expiry');
        },
        addListeners: function () {
          var self = this;

          // listen for submit button
          if (document.getElementById('checkout-form') !== null) {
            document
              .getElementById('checkout-form')
              .addEventListener('submit', self.onSubmit.bind(self));
          }

          customCheckout.on('brand', function (event) {
            console.log('brand: ' + JSON.stringify(event));

            var cardLogo = 'none';
            if (event.brand && event.brand !== 'unknown') {
              var filePath =
                'https://cdn.na.bambora.com/downloads/images/cards/' +
                event.brand +
                '.svg';
              cardLogo = 'url(' + filePath + ')';
            }
            document.getElementById('card-number').style.backgroundImage = cardLogo;
          });

          customCheckout.on('blur', function (event) {
            console.log('blur: ' + JSON.stringify(event));
          });

          customCheckout.on('focus', function (event) {
            console.log('focus: ' + JSON.stringify(event));
          });

          customCheckout.on('empty', function (event) {
            console.log('empty: ' + JSON.stringify(event));

            if (event.empty) {
              if (event.field === 'card-number') {
                isCardNumberComplete = false;
              } else if (event.field === 'cvv') {
                isCVVComplete = false;
              } else if (event.field === 'expiry') {
                isExpiryComplete = false;
              }
              self.setPayButton(false);
            }
          });

          customCheckout.on('complete', function (event) {
            console.log('complete: ' + JSON.stringify(event));

            if (event.field === 'card-number') {
              isCardNumberComplete = true;
              self.hideErrorForId('card-number');
            } else if (event.field === 'cvv') {
              isCVVComplete = true;
              self.hideErrorForId('card-cvv');
            } else if (event.field === 'expiry') {
              isExpiryComplete = true;
              self.hideErrorForId('card-expiry');
            }

            self.setPayButton(
              isCardNumberComplete && isCVVComplete && isExpiryComplete
            );
          });

          customCheckout.on('error', function (event) {
            console.log('error: ' + JSON.stringify(event));

            if (event.field === 'card-number') {
              isCardNumberComplete = false;
              self.showErrorForId('card-number', event.message);
            } else if (event.field === 'cvv') {
              isCVVComplete = false;
              self.showErrorForId('card-cvv', event.message);
            } else if (event.field === 'expiry') {
              isExpiryComplete = false;
              self.showErrorForId('card-expiry', event.message);
            }
            self.setPayButton(false);
          });
        },
        onSubmit: function (event) {
          var self = this;

          console.log('checkout.onSubmit()');

          event.preventDefault();
          self.setPayButton(false);
          self.toggleProcessingScreen();

          var callback = function (result) {
            console.log('token result : ' + JSON.stringify(result));

            if (result.error) {
              self.processTokenError(result.error);
            } else {
              self.processTokenSuccess(result.token);
            }
          };

          console.log('checkout.createToken()');
          customCheckout.createToken(callback);
        },
        hideErrorForId: function (id) {
          console.log('hideErrorForId: ' + id);

          var element = document.getElementById(id);

          if (element !== null) {
            var errorElement = document.getElementById(id + '-error');
            if (errorElement !== null) {
              errorElement.innerHTML = '';
            }

            var bootStrapParent = document.getElementById(id + '-bootstrap');
            if (bootStrapParent !== null) {
              bootStrapParent.classList.remove('has-error');
              bootStrapParent.classList.add('has-success');
            }
          } else {
            console.log('showErrorForId: Could not find ' + id);
          }
        },
        showErrorForId: function (id, message) {
          console.log('showErrorForId: ' + id + ' ' + message);

          var element = document.getElementById(id);

          if (element !== null) {
            var errorElement = document.getElementById(id + '-error');
            if (errorElement !== null) {
              errorElement.innerHTML = message;
            }

            var bootStrapParent = document.getElementById(id + '-bootstrap');
            if (bootStrapParent !== null) {
              bootStrapParent.classList.add('has-error');
              bootStrapParent.classList.remove('has-success');
            }
          } else {
            console.log('showErrorForId: Could not find ' + id);
          }
        },
        setPayButton: function (enabled) {
          console.log('checkout.setPayButton() disabled: ' + !enabled);

          var payButton = document.getElementById('pay-button');
          if (enabled) {
            payButton.disabled = false;
            payButton.className = 'btn btn-primary';
          } else {
            payButton.disabled = true;
            payButton.className = 'btn btn-primary disabled';
          }
        },
        toggleProcessingScreen: function () {
          var processingScreen = document.getElementById('processing-screen');
          if (processingScreen) {
            processingScreen.classList.toggle('visible');
          }
        },
        showErrorFeedback: function (message) {
          var xMark = '\u2718';
          this.feedback = document.getElementById('feedback');
          this.feedback.innerHTML = xMark + ' ' + message;
          this.feedback.classList.add('mt-3', 'alert', 'alert-danger');
        },
        showSuccessFeedback: function (message) {
          var checkMark = '\u2714';
          this.feedback = document.getElementById('feedback');
          this.feedback.innerHTML = checkMark + ' ' + message;
          this.feedback.classList.add('mt-3', 'alert', 'alert-success');
        },
        processTokenError: function (error) {
          error = JSON.stringify(error, undefined, 2);
          console.log('processTokenError: ' + error);

          this.showErrorFeedback(
            'Error creating token: </br>' + JSON.stringify(error, null, 4)
          );
          this.setPayButton(true);
          this.toggleProcessingScreen();
        },
        processTokenSuccess: function (token) {
          console.log('processTokenSuccess: ' + token);

          this.showSuccessFeedback('Success! Created token: ' + token);
          this.setPayButton(true);
          this.toggleProcessingScreen();

          tokenInput = document.getElementById('cc-token');
          tokenInput.value = token;
        },
      };

      customCheckoutController.init();
    })();
  </script>
</body>

</html>